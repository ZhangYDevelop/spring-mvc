<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
               http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
            http://www.springframework.org/schema/security
            http://www.springframework.org/schema/security/spring-security-4.2.xsd">

<security:http pattern="/api/platform/login" security="none" />
<!--&lt;!&ndash; 资源文件不拦截 &ndash;&gt;-->
<security:http pattern="/resources/**" security="none" />

<security:http auto-config="false" use-expressions="true" entry-point-ref="myUrlEntryPoint">
    <security:logout logout-success-url="/api/platform/logout" />
    <security:session-management invalid-session-url="/api/platform/login?error=3"
                                 session-fixation-protection="none">
        <security:concurrency-control max-sessions="1"
                                      error-if-maximum-exceeded="true" expired-url="/api/platform/login?error=2" /><!-- 阻止第二次登录 -->
    </security:session-management>
    <!-- 登录过滤器 -->
    <security:custom-filter before="FORM_LOGIN_FILTER" ref="loginFilter"   />
    <security:custom-filter  before="FILTER_SECURITY_INTERCEPTOR" ref="securityFilter"/>
    <!-- 注销过滤器 -->
    <!-- <custom-filter before="LOGOUT_FILTER" ref="logoutFilter"/> -->
</security:http>

<!--&lt;!&ndash; 认证切入点，这里使用它的目的是保证当用户登录之前就访问前后台时，会跳转到不同的登录页面 &ndash;&gt;-->
<bean id ="myUrlEntryPoint" class="com.zy.springmvc.security.UrlEntryPoint"></bean>



<bean id="loginFilter" class="com.zy.springmvc.security.UserNamePasswarkAuthenticationFilter">
    <property name="authenticationManager" ref="myAuthenticationManager"></property>
    <property name="usernameParameter" value="userName"></property>
    <property name="passwordParameter" value="userPwd"></property>
    <!--<property name="validateCodeParameter" value="userCode"></property>-->
    <!--<property name="openValidateCode" value="true" />-->
    <property name="filterProcessesUrl" value="/api/platform/login" />
    <property name="authenticationFailureHandler" ref="myFailureHandler"/>
    <property name="authenticationSuccessHandler" ref="mySuccessHandler"/>
</bean>

<bean id="myAccessDecisionManager" class="com.zy.springmvc.security.MyAccessDecisionManager"></bean>
<bean id="mySecurityMetadataSource" class="com.zy.springmvc.security.MySecurityMetadataSource"></bean>
<bean id="myUserDetailsServiceImpl" class="com.zy.springmvc.security.UserDetailsServiceImpl"></bean>

<bean id="securityFilter" class="com.zy.springmvc.security.MySecurityFilter">
    <!-- 用户拥有的权限 -->
    <property name="authenticationManager" ref="myAuthenticationManager" />
    <!-- 用户是否拥有所请求资源的权限 -->
    <property name="accessDecisionManager" ref="myAccessDecisionManager" />
    <!-- 资源与权限对应关系 -->
    <property name="securityMetadataSource" ref="mySecurityMetadataSource" />
</bean>

<!--&lt;!&ndash; 登录成功业务处理 &ndash;&gt;-->
<bean id="mySuccessHandler" class="com.zy.springmvc.security.MyAuthenticationSuccessHandler">
    <property name="url" value="/index"></property>
</bean>

<!--&lt;!&ndash; 登录失败业务处理 &ndash;&gt;-->
<bean id="myFailureHandler" class="com.zy.springmvc.security.MyAuthenticationFailureHandler"/>

<bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.Md5PasswordEncoder" />

<security:authentication-manager alias="myAuthenticationManager">
    <security:authentication-provider user-service-ref="myUserDetailsServiceImpl">
        <security:password-encoder ref="passwordEncoder" hash="md5"></security:password-encoder>
    </security:authentication-provider>
</security:authentication-manager>

    <!--<?xml version="1.0" encoding="UTF-8"?>-->
    <!--<beans xmlns="http://www.springframework.org/schema/beans"-->
           <!--xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"-->
           <!--xmlns:security="http://www.springframework.org/schema/security"-->
           <!--xsi:schemaLocation="http://www.springframework.org/schema/beans-->
               <!--http://www.springframework.org/schema/beans/spring-beans-4.2.xsd-->
            <!--http://www.springframework.org/schema/security-->
            <!--http://www.springframework.org/schema/security/spring-security-4.2.xsd">-->

        <!--<security:http >-->
            <!--&lt;!&ndash;&lt;!&ndash; 登录页面不拦截 &ndash;&gt;&ndash;&gt;-->
            <!--<security:intercept-url pattern="/api/platform/login" access="permitAll()" />-->

            <!--&lt;!&ndash;&lt;!&ndash; 资源文件不拦截 &ndash;&gt;&ndash;&gt;-->
            <!--<security:intercept-url pattern="/resources/**" access="permitAll()" />-->
            <!--<security:intercept-url pattern="/**" access="isFullyAuthenticated()"/>-->
            <!--<security:form-login login-page="/api/platform/login"  login-processing-url="/api/platform/userLogin"-->
                                 <!--default-target-url="/api/platform/main"/>-->

            <!--<security:access-denied-handler error-page="/api/platform/error"/>-->

            <!--<security:csrf disabled="true"/>-->

        <!--</security:http>-->


        <!--<bean id="myUserDetailsServiceImpl" class="com.zy.springmvc.security.UserDetailsServiceImpl"></bean>-->

        <!--<bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.Md5PasswordEncoder" />-->

        <!--<security:authentication-manager >-->
            <!--<security:authentication-provider user-service-ref="myUserDetailsServiceImpl" >-->
            <!--</security:authentication-provider>-->
        <!--</security:authentication-manager>-->
    <!--</beans>-->
</beans>